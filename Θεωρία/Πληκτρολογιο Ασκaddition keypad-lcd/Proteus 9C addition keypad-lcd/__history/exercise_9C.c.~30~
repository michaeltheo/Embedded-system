#include <main-proteus.h>
#include <keypad-proteus.h> // πρόγραμμα ανάγνωσης από πληκτρολόγιο 4Χ4
         //Προσοχή!!! Η πόρτα B χρησιμοποιείται για το 
         //πληκτρολόγιο. Να ελεγχθούν οι ορισμοί των συνδέσεων
         // στο αρχείο keypad.h. Ανοίξτε το με το notepad και 
         //διορθώστε τους ορισμούς των συνδέσεων αν δεν 
         //ανταποκρίνονται στο σχέδιο.
#include <flex_lcd-proteus.h> //πρόγραμμα εμφάνισης σε οθόνη LCD δύο γραμμών
         //Προσοχή!!! Η πόρτα D χρησιμοποιείται για την οδήγηση της
         //οθόνης. Να ελεγχθούν οι ορισμοί των συνδέσεων
         // στο αρχείο flex_lcd.h. Ανοίξτε το με το notepad και 
         //διορθώστε τους ορισμούς των συνδέσεων αν δεν
         //ανταποκρίνονται στο σχέδιο.
#byte PORTB=0xf81  //θέση του καταχωρητή δεδομένων της πόρτας Β
#byte PORTD=0xf83  // θέση του καταχωρητή δεδομένων της πόρτας D

// Δήλωση μεταβλητών
char state=1;
int N1=0;
int N2=0;
int sum;

// Δήλωση ρουτινών, συναρτήσεων
void init(void);


//Κύριο πρόγραμμα
void main()
{
char k; // μεταβλητή char για αποθήκευση του ASCII κώδικα του πληκτρου
   // που πατήθηκε
init();  // αρχικοποίηση, η συνάρτηση αρχικοποίησης έχει γραφεί στο τέλος
lcd_init(); //αρχικοποίηση της οθόνης lcd.
kbd_init(); // αρχικοποίηση της συνάρτησης ανάγνωσης από το πληκτρολόγιο

while(TRUE)     {   // εκτελείται συνεχώς ένας βρόχος
      
      switch(state)   {
      case 1:
         k=kbd_getc();
         if(k!=0)
         {
         N1=k&0b00001111;
         printf(lcd_putc,"%1d+",N1);
         state=2;
         break;
         }
         break;
      case 2 :
         k=kbd_getc();
         if(k!=0)
         {
         N2=k&0b00001111;
         printf(lcd_putc,"%1d=",N2);
         sum=N2+N1;
         printf(lcd_putc,"%1d",sum);
         state=1;
            delay_ms(2000);
            lcd_putc("\f");
            while(TRUE){}
            break;
}  //κλείνει το while(k!=0)
}//κλείνει το switch(state)
      } //κλείνει η αγκύλη του while(TRUE)
} // κλείνει η αγκύλη της main

// Κώδικας της συνάρτησης αρχικοποίησης
void init(void){
set_tris_d(0x00); // Η πόρτα D γίνεται έξοδος, χρησιμοποιείται για την οδήγηση
          // της οθόνης LCD
           }


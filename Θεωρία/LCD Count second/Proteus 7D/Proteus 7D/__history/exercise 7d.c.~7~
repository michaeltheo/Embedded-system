#include <main-proteus.h>
#include <flex_lcd-proteus.h>       // Το h αρχείο του προγράμματος οδήγησης της οθόνης θα 
                     // πρέπει να είναι στον ίδιο φάκελο όπου θα αποθηκεύσουμε
                     //το πρόγραμμα μας.

                     //θα πρέπει να γίνει έλεγχος και πιθανόν τροποποίηση 
                     // στις δηλώσεις #define LCD_DB4 PIN_B4 κλπ που
                     // υπάρχουν στην flex_lcd.c. Με αυτές τις
                     // δηλώσεις καθορίζεται σε ποιους ακροδέκτες του 
                     // μικροελεγκτή συνδέεται ο κάθε ακροδέκτης της οθόνης.

            // Ανοίξτε το flex_lcd.h με το Notepad και κάνετε
            //έλεγχο στις δηλώσεις σύνδεσης των ακροδεκτών. Αν δεν
            //συμφωνούν με τον τρόπο που συνδέσατε τον μικροελεγκτή στην 
            //οθόνη θα πρέπει να κάνετε τροποποιήσεις. 

#byte PORTB=0xf81       // στην θέση 0xf81 είναι ο καταχωρητής δεδομένων 
                           //της πόρτας Β

 // Δήλωση μεταβλητών
int counter=20;       //Μετρητής διακοπών (μετά από 20 διακοπές ανά 50 ms θα έχουν
                      // περάσει 20Χ50=1000 ms=1 second.

int seconds=0;      // μεταβλητή της οποίας η τιμή θα εμφανίζεται στην οθόνη

// Δήλωση συναρτήσεων
void timer0_int(void);     //Οι συναρτήσεις που θα χρησιμοποιηθούν δηλώνονται πάνω από την main()
void init (void);

void main() {
init();                 //κλήση της ρουτίνας αρχικοποίησης
lcd_init();             // αρχικοποίηση της οθόνης
lcd_putc("\f");         // καθαρισμός της οθόνης
                 }      // κλείνει η αγκύλη του main


// Ρουτίνα διακοπής από τον timer0. 
#INT_TIMER0          // Directive. Οδηγία προς τον Compiler. Δηλώνει ότι η επόμενη ρουτίνα
                     // είναι ρουτίνα
                     // διακοπών από τον timer0
void timer0_int(void){
         set_timer0(56161);         // αρχική τιμή του μετρητή
                                    // για να συμβεί η επόμενη
                                    // διακοπή σε 50ms
         counter--;                 // ελαττώνεται ο μετρητής διακοπών
if (counter==0) {
      counter=20;                   //o counter ξαναπαίρνει την τιμή 20 για να μετρήσει άλλες 20 διακοπές
      seconds++;                    //κάθε 20 διακοπές ο αριθμός των δευτερολέπτων αυξάνει κατά 1
      lcd_gotoxy(5,1);               // Οδηγία να γράψει η οθόνη στην 5η θέση της πρώτης γραμμής
      printf(lcd_putc,"SECONDS=%d",seconds);  // Εκτυπώνεται το SECONDS= και στη 
                                             // στη συνέχεια η τιμή της μεταβλητής seconds στο δεκαδικό 
                                             // αριθμητικό σύστημα  
                  }                          
                   }                         //αγκύλη κλεισίματος της ρουτίνας διακοπών

// Ρουτίνα αρχικοποίησης
void init (void){
           set_tris_b(0x00);              // Καθορισμός της πόρτας Β ως εξόδου
           set_tris_d(0x00);              // Καθορισμός της πόρτας D ως εισόδου
           seconds=0;                     // Αρχική τιμή του μετρητή δευτερολέπτων ίση με μηδέν
           counter=20;                    // Αρχική τιμή του counter=20. Μετά από 20 διακοπές ο counter θα γίνει 0
           SETUP_TIMER_0(T0_INTERNAL | T0_DIV_64 );    //Prescaler=1/64
            set_timer0(56161);                  //  Αρχική τιμή του  μετρητή timer0 για διακοπές
                                                //κάθε 50 ms 
            enable_interrupts(INT_TIMER0);   // Ενεργοποίηση της 
                                             //διακοπής του timer0
            enable_interrupts(GLOBAL);       // Ενεργοποίηση του γενικού 
                                             // διακόπτη των διακοπών   
               }

